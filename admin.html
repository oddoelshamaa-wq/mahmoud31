<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Elshamaa Pro - Enterprise</title>
    <style>
        :root { --main: #6366f1; --dark: #1e293b; --light: #f1f5f9; --danger: #ef4444; --green: #10b981; --warning: #f59e0b; }
        :root { --wa-bg: #efe7dd; --wa-header: #008069; --wa-my-msg: #d9fdd3; --wa-their-msg: #ffffff; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; transition: all 0.3s ease; }
        body { display: flex; height: 100vh; margin: 0; background: var(--light); overflow: hidden; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 350px; text-align: center; color: var(--dark); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; }
        .login-box button { width: 100%; padding: 12px; background: var(--main); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        aside { width: 260px; background: var(--dark); color: white; padding: 20px; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        aside h2 { text-align: center; margin-bottom: 20px; color: var(--main); letter-spacing: 2px; font-weight: 800; }
        .user-info { text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 20px; font-size: 13px; }
        .menu-btn { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 10px; display: flex; align-items: center; gap: 10px; color: #cbd5e1; font-size: 14px; }
        .menu-btn:hover, .menu-btn.active { background: rgba(255,255,255,0.1); color: white; transform: translateX(-5px); }
        .menu-btn.active { border-right: 4px solid var(--main); }
        main { flex: 1; padding: 25px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
        h3 { margin-bottom: 15px; color: var(--dark); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; font-size: 18px; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 8px; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--main); }
        button.action-btn { background: var(--main); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-left: 5px; }
        button.action-btn:hover { background: #4f46e5; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { padding: 20px; border-radius: 15px; color: white; position: relative; overflow: hidden; }
        .stat-card h1 { margin: 5px 0 0; font-size: 28px; }
        .bg-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .bg-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .bg-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { text-align: right; color: #64748b; padding: 10px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; color: var(--dark); vertical-align: middle; }
        .clickable-row { cursor: pointer; transition: 0.2s; }
        .clickable-row:hover { background-color: #f1f5f9; transform: scale(1.005); }
        .badge { padding: 4px 8px; border-radius: 15px; font-size: 11px; font-weight: bold; color: white; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        .delete-btn { background: #fee2e2; color: #ef4444; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .order-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-right: 5px solid var(--main); position: relative; }
        .prod-thumb { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; border: 1px solid #ddd; margin-left: 10px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 0.9em; margin-left: 5px; }
        .new-price { color: var(--green); font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 90%; max-width: 600px; padding: 25px; border-radius: 15px; animation: scaleUp 0.3s; position: relative; max-height: 90vh; overflow-y: auto; }
        @keyframes scaleUp { from{transform:scale(0.8); opacity:0} to{transform:scale(1); opacity:1} }
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; align-items: flex-end; border: 1px solid #bae6fd; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
        .filter-group label { font-size: 12px; font-weight: bold; color: #0284c7; }
        .chat-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 0; height: 500px; border: 1px solid #ddd; border-radius: 0; overflow: hidden; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chat-sidebar { border-left: 1px solid #eee; overflow-y: auto; background: white; }
        .chat-main { display: flex; flex-direction: column; background-color: var(--wa-bg); background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-blend-mode: overlay; position: relative; }
        #chatHeader { padding: 10px 15px; background: #f0f2f5; border-bottom: 1px solid #ddd; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; height: 60px; }
        .chat-user-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; flex-direction: column; gap: 5px; }
        .chat-user-item:hover { background: #f5f6f6; }
        .chat-user-item.active { background: #e9edef; border-right: 4px solid var(--wa-header); }
        .chat-msgs-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .msg { padding: 8px 12px; border-radius: 7px; max-width: 70%; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.4; }
        .msg.admin { align-self: flex-end; background: var(--wa-my-msg); color: #111; border-top-left-radius: 7px; border-top-right-radius: 0; margin-right: 5px; }
        .msg.admin::after { content: ""; position: absolute; top: 0; right: -10px; width: 0; height: 0; border: 10px solid transparent; border-top-color: var(--wa-my-msg); border-left: 0; border-bottom: 0; margin-top: 0; margin-right: 0; }
        .msg.user { align-self: flex-start; background: var(--wa-their-msg); color: #111; border-top-left-radius: 0; margin-left: 5px; }
        .msg.user::after { content: ""; position: absolute; top: 0; left: -10px; width: 0; height: 0; border: 10px solid transparent; border-top-color: var(--wa-their-msg); border-right: 0; border-bottom: 0; margin-top: 0; margin-left: 0; transform: scaleX(-1); }
        .chat-input-area { padding: 10px; background: #f0f2f5; display: flex; align-items: center; gap: 10px; }
        .chat-input-area input { margin: 0; border-radius: 20px; border: none; padding: 12px 20px; flex: 1; }
        .chat-input-area button { margin: 0; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 20px; }

        /* Ø³ØªØ§ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .option-container { margin-bottom: 15px; }
        .option-label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 14px; color: #334155; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .chk-btn {
            border: 1px solid #cbd5e1; background: white; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 13px; user-select: none; transition: 0.2s;
        }
        .chk-btn:hover { background: #f1f5f9; }
        .chk-btn.active { background: var(--main); color: white; border-color: var(--main); box-shadow: 0 2px 5px rgba(99, 102, 241, 0.4); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color:var(--main); margin-bottom:5px;">Elshamaa Pro</h2>
        <p style="margin-top:0; color:#666; font-size:14px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Firebase)</p>
        <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="window.funcs.login()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸ”</button>
        <p style="font-size:12px; margin-top:15px; color:#888;">Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: admin / 123</p>
    </div>
</div>

<aside id="mainSidebar" style="display:none;">
    <h2>ELSHAMAA</h2>
    <div class="user-info">
        <span id="currentUserDisplay">Admin</span><br>
        <small id="currentRoleDisplay" style="color:var(--green)">Online</small>
    </div>
    <div class="menu-btn active" data-role="all" onclick="window.funcs.showSection('stats', this)">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
    <div class="menu-btn" data-role="all" onclick="window.funcs.showSection('orders', this)">ğŸ’° Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© <span id="alertBadge" style="background:red;border-radius:50%;padding:2px 6px;font-size:10px;display:none;margin-right:5px;">!</span></div>
    <div class="menu-btn" data-role="admin,manager" onclick="window.funcs.showSection('archive', this)">ğŸ—„ï¸ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    <div class="menu-btn" data-role="admin,manager" onclick="window.funcs.showSection('add-product', this)">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div class="menu-btn" data-role="admin,manager" onclick="window.funcs.showSection('categories', this)">ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
    <div class="menu-btn" data-role="admin" onclick="window.funcs.showSection('users', this)">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
    <div class="menu-btn" data-role="admin,manager" onclick="window.funcs.showSection('reports', this)">ğŸ“ˆ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</div>
    <div class="menu-btn" data-role="all" onclick="window.funcs.showSection('messages', this)">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    <div style="margin-top:auto;">
        <button onclick="window.funcs.logout()" style="width:100%; background:rgba(255,255,255,0.1); border:none; color:white; padding:10px; cursor:pointer; border-radius:10px;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
    </div>
</aside>

<main id="mainContent" style="display:none;">
    
    <div id="stats" class="section active">
        <h2 style="color:var(--dark)">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
        <div class="stats-grid">
            <div class="stat-card bg-green"> <p>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø§Ù„Ù…Ø­ØµÙ„Ø©)</p> <h1 id="statRevenue">0</h1> </div>
            <div class="stat-card bg-blue"> <p>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</p> <h1 id="statOrders">0</h1> </div>
            <div class="stat-card bg-purple"> <p>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</p> <h1 id="statArchived">0</h1> </div>
            <div class="stat-card bg-orange"> <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p> <h1 id="statUsers">0</h1> </div>
        </div>
        <div class="card">
            <h3>ğŸ”¥ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
            <div id="topSellersList"></div>
        </div>
    </div>

    <div id="orders" class="section">
        <div class="card">
            <h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3>
            <div id="ordersList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <div id="archive" class="section">
        <div class="card">
            <h3>ğŸ—„ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…)</h3>
            <div class="filter-bar">
                <div class="filter-group"><label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù:</label><select id="archiveFilterEmp" onchange="window.funcs.renderArchive()"><option value="">-- ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† --</option></select></div>
                <div class="filter-group"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label><input type="date" id="archiveFilterFrom" onchange="window.funcs.renderArchive()"></div>
                <div class="filter-group"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label><input type="date" id="archiveFilterTo" onchange="window.funcs.renderArchive()"></div>
                <div class="filter-group" style="justify-content: flex-end; flex:0;"><button class="action-btn" onclick="window.funcs.resetArchiveFilters()" style="padding: 10px; background:#64748b;">Ø¥Ù„ØºØ§Ø¡ âŒ</button></div>
            </div>
            <div style="overflow-x:auto;">
                <table><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody id="archiveTableBody"></tbody></table>
            </div>
        </div>
    </div>

    <div id="add-product" class="section">
        <div class="card">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" style="flex:2">
                <input type="number" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ" style="flex:1">
                <input type="number" id="pDiscount" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="flex:1; border-color:var(--warning)">
                <input type="number" id="pQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" style="flex:1">
            </div>

            <!-- New Options UI -->
            <div style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                <div class="option-container">
                    <span class="option-label">ğŸ¨ Ø§Ø®ØªØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©:</span>
                    <div id="colorContainer" class="checkbox-group">
                        <!-- Populated via JS -->
                    </div>
                </div>
                <div class="option-container" style="margin-bottom:0;">
                    <span class="option-label">ğŸ“ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</span>
                    <div id="sizeContainer" class="checkbox-group">
                        <!-- Populated via JS -->
                    </div>
                </div>
            </div>

            <textarea id="pDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØªÙØ§ØµÙŠÙ„Ù‡ Ù‡Ù†Ø§..." rows="3"></textarea>
            <input type="text" id="pImg" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ (https://...)" style="width:100%; direction:ltr;">
            <div style="display:flex; gap:10px;">
                <select id="pCategory" onchange="window.funcs.updateSubCatsDropdown()"></select>
                <select id="pSubCategory"></select>
            </div>
            <button class="action-btn" onclick="window.funcs.addProduct()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</button>
        </div>
        <div class="card">
            <h3>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
            <div style="overflow-x:auto;">
                <table id="productsTable"><thead><tr><th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø£Ù„ÙˆØ§Ù†/Ù…Ù‚Ø§Ø³Ø§Øª</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªØ­ÙƒÙ…</th></tr></thead><tbody id="productsTableBody"></tbody></table>
            </div>
        </div>
    </div>

    <div id="categories" class="section">
        <div class="card">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newMainCat" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù….." style="flex:1">
                <button class="action-btn" onclick="window.funcs.addMainCat()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="mainCatList" style="margin-top:20px;"></div>
        </div>
        <div class="card">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ</h3>
            <div style="display:flex; gap:10px;">
                <select id="targetMainCat" style="flex:1"></select>
                <input type="text" id="newSubCat" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹.." style="flex:1">
                <button class="action-btn" onclick="window.funcs.addSubCat()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="subCatList" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="users" class="section">
        <div class="card">
            <h3>ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <input type="text" id="uName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ" style="flex:1">
                <input type="text" id="uUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="flex:1">
                <input type="text" id="uPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="flex:1">
                <select id="uRole" style="flex:1"><option value="seller">Ø¨Ø§Ø¦Ø¹</option><option value="manager">Ù…Ø¯ÙŠØ±</option><option value="admin">Ø£Ø¯Ù…Ù†</option></select>
                <button class="action-btn" onclick="window.funcs.addUser()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </div>
        </div>
        <div class="card">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
            <table id="usersTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="usersTableBody"></tbody></table>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="card">
            <h3>ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù…ÙÙ„ØªØ±)</h3>
            <div class="filter-bar">
                <div class="filter-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù:</label><select id="reportFilterEmp" onchange="window.funcs.renderReports()"><option value="">-- Ø§Ù„ÙƒÙ„ --</option></select></div>
                <div class="filter-group"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label><input type="date" id="reportFilterFrom" onchange="window.funcs.renderReports()"></div>
                <div class="filter-group"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label><input type="date" id="reportFilterTo" onchange="window.funcs.renderReports()"></div>
                <div class="filter-group" style="justify-content: flex-end; flex:0;"><button class="action-btn" onclick="window.funcs.resetReportFilters()" style="padding: 10px; background:#64748b;">Ø¥Ù„ØºØ§Ø¡</button></div>
            </div>
            <table id="reportsTable"><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©</th></tr></thead><tbody id="reportsTableBody"></tbody></table>
        </div>
    </div>

    <div id="messages" class="section">
        <div class="card" style="padding:0; overflow:hidden;">
            <div class="chat-layout">
                <div class="chat-sidebar" id="chatSidebar"></div>
                <div class="chat-main">
                    <div id="chatHeader">
                        <img src="https://placehold.co/40" style="border-radius:50%">
                        <div><div id="chatHeaderName">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</div><small id="chatHeaderStatus" style="font-weight:normal; color:#666;">...</small></div>
                    </div>
                    <div class="chat-msgs-box" id="adminChatBox"></div>
                    <div class="chat-input-area">
                        <input type="text" id="adminChatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." disabled>
                        <button class="action-btn" id="adminChatBtn" onclick="window.funcs.sendAdminReply()" disabled>â¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>

<div class="modal-overlay" id="orderDetailModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
            <h3 style="margin:0; border:none;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„ÙØ§ØªÙˆØ±Ø©)</h3>
            <button onclick="document.getElementById('orderDetailModal').style.display='none'" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div id="orderDetailContent"></div>
        <div style="text-align:left; margin-top:20px;"><button class="action-btn" style="background:#64748b;" onclick="document.getElementById('orderDetailModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, setDoc, getDoc, deleteDoc, updateDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC-WunzZkXYOeXNAKtFgnti0suXbvU74FY",
        authDomain: "stoer-elshamaa.firebaseapp.com",
        projectId: "stoer-elshamaa",
        storageBucket: "stoer-elshamaa.firebasestorage.app",
        messagingSenderId: "566386579692",
        appId: "1:566386579692:web:c8b293e634b5cb62c5adc9",
        measurementId: "G-P2JFPZ7LTL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); 
    let currentUser = null;
    let lastOrderCount = 0;
    let selectedChatUser = null;
    
    let allProducts = [];
    let allOrders = [];
    let allArchive = [];
    let allUsers = [];
    let allChats = [];
    let categoriesData = {};

    // Defined Options
    const commonColors = ["Ø£Ø³ÙˆØ¯", "Ø£Ø¨ÙŠØ¶", "Ø£Ø­Ù…Ø±", "Ø£Ø²Ø±Ù‚", "Ø£Ø®Ø¶Ø±", "Ø£ØµÙØ±", "Ø±ØµØ§ØµÙŠ", "Ø¨ÙŠØ¬", "ÙƒØ­Ù„ÙŠ", "Ø¨Ù†ÙŠ", "Ø°Ù‡Ø¨ÙŠ", "ÙØ¶ÙŠ", "ÙˆØ±Ø¯ÙŠ"];
    const commonSizes = ["XS", "S", "M", "L", "XL", "2XL", "3XL", "4XL", "38", "39", "40", "41", "42", "43", "44", "45"];

    window.funcs = {
        login: () => login(),
        logout: () => logout(),
        showSection: (id, btn) => showSection(id, btn),
        addProduct: () => addProduct(),
        updateSubCatsDropdown: () => updateSubCatsDropdown(),
        addMainCat: () => addMainCat(),
        addSubCat: () => addSubCat(),
        delMainCat: (k) => delMainCat(k),
        delSubCat: (m,s) => delSubCat(m,s),
        addUser: () => addUser(),
        delUser: (id) => delUser(id),
        updateOrderStatus: (id, st) => updateOrderStatus(id, st),
        renderArchive: () => renderArchive(),
        resetArchiveFilters: () => resetArchiveFilters(),
        renderReports: () => renderReports(),
        resetReportFilters: () => resetReportFilters(),
        openOrderDetailModal: (id, src) => openOrderDetailModal(id, src),
        changeStock: (id) => changeStock(id),
        delProd: (id) => delProd(id),
        openChat: (p) => openChat(p),
        sendAdminReply: () => sendAdminReply(),
        toggleOption: (btn) => toggleOption(btn)
    };

    window.addEventListener('load', () => {
        const session = localStorage.getItem('elshamaaSession');
        if(session) grantAccess(JSON.parse(session));
        renderOptions();
    });

    // Toggle Checkbox Button
    function toggleOption(btn) {
        btn.classList.toggle('active');
    }

    function renderOptions() {
        const cContainer = document.getElementById('colorContainer');
        const sContainer = document.getElementById('sizeContainer');
        cContainer.innerHTML = ""; sContainer.innerHTML = "";

        commonColors.forEach(c => {
            cContainer.innerHTML += `<div class="chk-btn" onclick="window.funcs.toggleOption(this)" data-val="${c}">${c}</div>`;
        });

        commonSizes.forEach(s => {
            sContainer.innerHTML += `<div class="chk-btn" onclick="window.funcs.toggleOption(this)" data-val="${s}">${s}</div>`;
        });
    }

    async function login() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        
        if(u === "admin" && p === "123") {
            const adminUser = { id: 'master', name: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…", user: "admin", role: "admin" };
            localStorage.setItem('elshamaaSession', JSON.stringify(adminUser));
            grantAccess(adminUser);
            return;
        }

        try {
            const q = query(collection(db, "system_users"), where("user", "==", u), where("pass", "==", p));
            const snap = await getDocs(q);
            if(!snap.empty) {
                const user = { id: snap.docs[0].id, ...snap.docs[0].data() };
                localStorage.setItem('elshamaaSession', JSON.stringify(user));
                grantAccess(user);
            } else {
                alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©");
            }
        } catch(e) { console.error(e); alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); }
    }

    function grantAccess(user) {
        currentUser = user;
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainSidebar').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('currentUserDisplay').innerText = user.name;
        document.getElementById('currentRoleDisplay').innerText = user.role.toUpperCase();
        
        setupPermissions(user.role);
        startRealtimeListeners();
    }

    function logout() { localStorage.removeItem('elshamaaSession'); location.reload(); }

    function setupPermissions(role) {
        document.querySelectorAll('.menu-btn').forEach(btn => {
            const allowed = btn.getAttribute('data-role');
            btn.style.display = (allowed === 'all' || allowed.includes(role)) ? 'flex' : 'none';
        });
    }

    function startRealtimeListeners() {
        onSnapshot(collection(db, "products"), (snap) => {
            allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderProducts(); renderStats();
        });

        onSnapshot(collection(db, "orders"), (snap) => {
            allOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
            checkNewOrders(allOrders);
            renderOrders(); renderStats();
        });

        const qArch = query(collection(db, "archive"), orderBy("timestamp", "desc"));
        onSnapshot(qArch, (snap) => {
            allArchive = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderStats();
            if(document.getElementById('archive').classList.contains('active')) renderArchive();
            if(document.getElementById('reports').classList.contains('active')) renderReports();
        });

        onSnapshot(doc(db, "settings", "categories"), (doc) => {
            if(doc.exists()) {
                categoriesData = doc.data();
                renderCategoryUI();
            }
        });

        if(currentUser.role === 'admin') {
            onSnapshot(collection(db, "system_users"), (snap) => {
                allUsers = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderUsers(); renderStats();
                populateEmpFilter();
            });
        }

        onSnapshot(collection(db, "chats"), (snap) => {
            allChats = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderChatList();
            if(selectedChatUser) {
                const c = allChats.find(x => x.id === selectedChatUser);
                if(c) renderChatBox(c.messages || []);
            }
        });
    }

    function checkNewOrders(orders) {
        const hasPending = orders.some(o => o.status === 'pending' || o.status === 'cancel_requested');
        document.getElementById('alertBadge').style.display = hasPending ? 'inline-block' : 'none';
        if(hasPending && orders.length > lastOrderCount) {
             beep.play().catch(e=>{});
        }
        lastOrderCount = orders.length;
    }

    async function addProduct() {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        const discount = document.getElementById('pDiscount').value;
        const qty = document.getElementById('pQty').value;
        const cat = document.getElementById('pCategory').value;
        const sub = document.getElementById('pSubCategory').value;
        const desc = document.getElementById('pDesc').value;
        const img = document.getElementById('pImg').value;

        // Get selected colors and sizes
        const selectedColors = Array.from(document.querySelectorAll('#colorContainer .chk-btn.active')).map(el => el.dataset.val);
        const selectedSizes = Array.from(document.querySelectorAll('#sizeContainer .chk-btn.active')).map(el => el.dataset.val);

        if(!name || !price) return alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");

        await addDoc(collection(db, "products"), {
            name, price, discountPrice: discount, quantity: parseInt(qty), 
            category: cat, subCategory: sub, description: desc, img, sold: 0,
            colors: selectedColors, sizes: selectedSizes
        });

        // Reset Form
        document.getElementById('pName').value = "";
        document.getElementById('pPrice').value = "";
        // Reset checkboxes
        document.querySelectorAll('.chk-btn.active').forEach(b => b.classList.remove('active'));
        
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }

    function renderProducts() {
        let tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = "";
        allProducts.forEach((p) => { 
            let priceDisplay = `${p.price}`;
            if(p.discountPrice) priceDisplay = `<span class="old-price">${p.price}</span> <span class="new-price">${p.discountPrice}</span>`;
            
            let variants = "";
            if(p.colors && p.colors.length) variants += `ğŸ¨: ${p.colors.join(' ')}<br>`;
            if(p.sizes && p.sizes.length) variants += `ğŸ“: ${p.sizes.join(' ')}`;

            tbody.innerHTML += `<tr>
                <td><img src="${p.img || 'https://placehold.co/50'}" style="width:50px;"></td>
                <td>${p.name}</td>
                <td><small>${variants}</small></td>
                <td>${p.category}</td>
                <td>${priceDisplay}</td>
                <td>${p.quantity} <button class="action-btn" style="padding:2px 5px;" onclick="window.funcs.changeStock('${p.id}')">âœï¸</button></td>
                <td><button onclick="window.funcs.delProd('${p.id}')" style="color:red;border:none;background:none;cursor:pointer">ğŸ—‘ï¸</button></td>
            </tr>`; 
        });
        updateSubCatsDropdown();
    }

    async function changeStock(id) {
        let p = allProducts.find(x => x.id == id);
        let amount = prompt(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù€ ${p.name} (Ø§Ù„Ø­Ø§Ù„ÙŠ ${p.quantity}) \nØ£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ© (Ø£Ùˆ Ø³Ø§Ù„Ø¨ Ù„Ù„Ø®ØµÙ…):`);
        if(amount && !isNaN(amount)) {
            let newQ = parseInt(p.quantity) + parseInt(amount);
            if(newQ < 0) newQ = 0;
            await updateDoc(doc(db, "products", id), { quantity: newQ });
        }
    }

    async function delProd(id) {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) await deleteDoc(doc(db, "products", id));
    }

    function renderOrders() {
        const list = document.getElementById('ordersList');
        list.innerHTML = allOrders.length ? "" : "<p style='text-align:center;color:#999'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</p>";
        allOrders.sort((a,b)=>b.timestamp - a.timestamp).forEach(o => {
            let items = o.items ? o.items.map(i => {
                let det = i.selectedColor || i.selectedSize ? `(${i.selectedColor||''} ${i.selectedSize||''})` : '';
                return `${i.name} ${det}`;
            }).join(' + ') : o.productName;
            
            let options = '';
            let extraStyle = '';

            if(o.status === 'pending') {
                options = `
                    <button class="action-btn" onclick="window.funcs.updateOrderStatus('${o.id}', 'shipped')">Ø´Ø­Ù† ğŸšš</button>
                    <button class="action-btn" style="background:var(--danger)" onclick="window.funcs.updateOrderStatus('${o.id}', 'cancelled')">Ø¥Ù„ØºØ§Ø¡ âŒ</button>
                `;
            } else if (o.status === 'shipped') {
                options = `
                    <button class="action-btn" onclick="window.funcs.updateOrderStatus('${o.id}', 'completed')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…</button>
                    <button class="action-btn" style="background:var(--danger)" onclick="window.funcs.updateOrderStatus('${o.id}', 'returned')">Ù…Ø±ØªØ¬Ø¹ â†©ï¸</button>
                `;
            } else if (o.status === 'cancel_requested') {
                extraStyle = "border-right: 5px solid #f59e0b; background:#fffcf2;";
                options = `
                    <div style="background:#fff3cd; color:#856404; padding:5px;">âš ï¸ Ø·Ù„Ø¨ Ø¥Ù„ØºØ§Ø¡: ${o.clientCancelReason}</div>
                    <button class="action-btn" onclick="window.funcs.updateOrderStatus('${o.id}', 'cancelled')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                    <button class="action-btn" style="background:var(--danger)" onclick="window.funcs.updateOrderStatus('${o.id}', 'shipped')">Ø±ÙØ¶ (ÙˆØ´Ø­Ù†)</button>
                `;
            }

            list.innerHTML += `
                <div class="order-card" style="${extraStyle}">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${o.user?.name}</strong> <span style="color:var(--green)">${o.total}</span>
                    </div>
                    <small>${items}</small>
                    <div style="margin-top:10px;">${options} <button class="action-btn" style="background:#64748b" onclick="window.funcs.openOrderDetailModal('${o.id}', 'active')">ØªÙØ§ØµÙŠÙ„</button></div>
                </div>`;
        });
    }

    async function updateOrderStatus(id, status) {
        let note = "";
        if(status === 'cancelled' || status === 'returned') {
            note = prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡/Ø§Ù„Ø§Ø±ØªØ¬Ø§Ø¹:");
            if(note === null) return;
        }

        const order = allOrders.find(o => o.id == id);
        if(!order) return;

        if(status === 'completed' || status === 'cancelled' || status === 'returned') {
            const archiveData = {
                ...order,
                status: status,
                archiveNote: note,
                archivedDate: new Date().toLocaleString(),
                processedBy: currentUser.name,
                timestamp: Date.now()
            };
            await addDoc(collection(db, "archive"), archiveData);
            await deleteDoc(doc(db, "orders", id));
            
            if(status === 'completed' && order.items) {
                order.items.forEach(item => {
                    const p = allProducts.find(x => x.id == item.id);
                    if(p) updateDoc(doc(db, "products", p.id), { sold: (p.sold||0) + 1 });
                });
            }

        } else {
            await updateDoc(doc(db, "orders", id), { status: status });
        }
    }

    function renderArchive() {
        const tbody = document.getElementById('archiveTableBody');
        tbody.innerHTML = "";
        const emp = document.getElementById('archiveFilterEmp').value;
        const from = document.getElementById('archiveFilterFrom').value;
        const to = document.getElementById('archiveFilterTo').value;

        let filtered = allArchive.filter(o => {
            if(emp && o.processedBy !== emp) return false;
            return true; 
        });

        filtered.forEach(o => {
            tbody.innerHTML += `<tr class="clickable-row" onclick="window.funcs.openOrderDetailModal('${o.id}', 'archive')">
                <td>#${o.id.substring(0,6)}</td><td>${o.user?.name}</td><td style="color:var(--green)">${o.total}</td>
                <td>${o.status}</td><td>${o.processedBy}</td><td>${o.archivedDate}</td>
            </tr>`;
        });
    }

    function renderReports() {
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = "";
        let data = {};
        allArchive.forEach(o => {
            if(o.status === 'completed') {
                let u = o.processedBy || 'Unknown';
                if(!data[u]) data[u] = {count:0, total:0};
                data[u].count++;
                data[u].total += parseFloat(o.total || 0);
            }
        });
        Object.keys(data).forEach(k => {
            tbody.innerHTML += `<tr><td>${k}</td><td>${data[k].count}</td><td>${data[k].total} Ø¬.Ù…</td></tr>`;
        });
    }

    function renderCategoryUI() {
        const cats = categoriesData || {};
        const pCat = document.getElementById('pCategory');
        pCat.innerHTML = Object.keys(cats).map(c => `<option value="${c}">${c}</option>`).join('');
        updateSubCatsDropdown();
        
        const mainList = document.getElementById('mainCatList');
        const targetList = document.getElementById('targetMainCat');
        const subList = document.getElementById('subCatList');
        mainList.innerHTML = ""; targetList.innerHTML = ""; subList.innerHTML = "";
        
        Object.keys(cats).forEach(key => {
            mainList.innerHTML += `<div class="cat-item"><strong>${key}</strong><button class="delete-btn" onclick="window.funcs.delMainCat('${key}')">Ø­Ø°Ù</button></div>`;
            targetList.innerHTML += `<option value="${key}">${key}</option>`;
            if(cats[key].length > 0) {
                cats[key].forEach(sub => {
                    subList.innerHTML += `<div class="cat-item"><span>${key} > <strong>${sub}</strong></span><button class="delete-btn" onclick="window.funcs.delSubCat('${key}','${sub}')">Ø­Ø°Ù</button></div>`;
                });
            }
        });
    }

    function updateSubCatsDropdown() {
        const main = document.getElementById('pCategory').value;
        const sub = document.getElementById('pSubCategory');
        sub.innerHTML = (categoriesData[main] || []).map(s => `<option value="${s}">${s}</option>`).join('');
    }

    async function saveCats() { await setDoc(doc(db, "settings", "categories"), categoriesData); }
    async function addMainCat() { let v = document.getElementById('newMainCat').value; if(v){ categoriesData[v]=[]; await saveCats(); } }
    async function delMainCat(k) { if(confirm("Ø­Ø°ÙØŸ")) { delete categoriesData[k]; await saveCats(); } }
    async function addSubCat() { let m=document.getElementById('targetMainCat').value, s=document.getElementById('newSubCat').value; if(s){ categoriesData[m].push(s); await saveCats(); } }
    async function delSubCat(m,s) { if(confirm("Ø­Ø°ÙØŸ")) { categoriesData[m] = categoriesData[m].filter(x=>x!==s); await saveCats(); } }

    async function addUser() {
        const uName = document.getElementById('uName').value;
        const uUser = document.getElementById('uUser').value;
        const uPass = document.getElementById('uPass').value;
        const uRole = document.getElementById('uRole').value;
        if(uUser && uPass) {
            await addDoc(collection(db, "system_users"), { name: uName, user: uUser, pass: uPass, role: uRole });
            document.getElementById('uUser').value = "";
        }
    }
    function renderUsers() {
        const t = document.getElementById('usersTableBody'); t.innerHTML = "";
        allUsers.forEach(u => {
            t.innerHTML += `<tr><td>${u.name}</td><td>${u.user}</td><td>${u.role}</td><td><button onclick="window.funcs.delUser('${u.id}')">âŒ</button></td></tr>`;
        });
    }
    async function delUser(id) { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, "system_users", id)); }

    function renderChatList() {
        const sidebar = document.getElementById('chatSidebar');
        sidebar.innerHTML = "";
        allChats.forEach(c => {
            let last = c.messages ? c.messages[c.messages.length-1].text : '';
            sidebar.innerHTML += `
                <div class="chat-user-item ${selectedChatUser===c.id?'active':''}" onclick="window.funcs.openChat('${c.id}')">
                    <strong>${c.id}</strong><br><small style="color:#666">${last}</small>
                </div>`;
        });
    }

    function openChat(phone) {
        selectedChatUser = phone;
        document.getElementById('chatHeaderName').innerText = phone;
        document.getElementById('adminChatInput').disabled = false;
        document.getElementById('adminChatBtn').disabled = false;
        
        const chat = allChats.find(c => c.id === phone);
        renderChatBox(chat ? chat.messages : []);
    }

    function renderChatBox(msgs) {
        const box = document.getElementById('adminChatBox');
        box.innerHTML = "";
        msgs.forEach(m => {
            box.innerHTML += `<div class="msg ${m.sender}">${m.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    async function sendAdminReply() {
        const txt = document.getElementById('adminChatInput').value;
        if(!txt || !selectedChatUser) return;
        
        const chatRef = doc(db, "chats", selectedChatUser);
        const chat = allChats.find(c => c.id === selectedChatUser);
        let msgs = chat ? [...chat.messages] : [];
        msgs.push({ sender: 'admin', text: txt, time: Date.now() });

        await setDoc(chatRef, { messages: msgs }, { merge: true });
        document.getElementById('adminChatInput').value = "";
    }

    function openOrderDetailModal(id, src) {
        let order = (src==='active') ? allOrders.find(o=>o.id==id) : allArchive.find(o=>o.id==id);
        if(!order) return;
        let content = document.getElementById('orderDetailContent');
        let itemsHtml = (order.items || []).map(i => {
            let detail = (i.selectedColor || i.selectedSize) ? `<br><small style="color:#666">(${i.selectedColor || '-'} | ${i.selectedSize || '-'})</small>` : '';
            return `<li>${i.name} ${detail} <span style="float:left">${i.price}</span></li>`;
        }).join('');
        
        content.innerHTML = `
            <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.user?.name}<br>
            <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${order.user?.phone}<br>
            <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.address}<br>
            <hr>
            <ul>${itemsHtml}</ul>
            <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total}</h3>
        `;
        document.getElementById('orderDetailModal').style.display = 'flex';
    }

    function renderStats() {
        document.getElementById('statOrders').innerText = allOrders.length;
        document.getElementById('statArchived').innerText = allArchive.length;
        document.getElementById('statUsers').innerText = allUsers.length;
        let rev = 0; allArchive.forEach(a=>{if(a.status==='completed') rev += parseFloat(a.total||0)});
        document.getElementById('statRevenue').innerText = rev;

        let counts = {};
        allProducts.forEach(p => counts[p.name] = (p.sold||0));
        const list = document.getElementById('topSellersList'); list.innerHTML = "";
        Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([n,c], i) => {
            list.innerHTML += `<div>${i+1}. ${n} (${c} Ø¨ÙŠØ¹)</div>`;
        });
    }
    
    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'users' && currentUser.role==='admin') renderUsers();
        if(id === 'archive') renderArchive();
        if(id === 'reports') renderReports();
    }
    function populateEmpFilter() {
        const sel = document.getElementById('archiveFilterEmp');
        sel.innerHTML = '<option value="">-- Ø§Ù„ÙƒÙ„ --</option>';
        allUsers.forEach(u => sel.innerHTML += `<option value="${u.name}">${u.name}</option>`);
        document.getElementById('reportFilterEmp').innerHTML = sel.innerHTML;
    }
    function resetArchiveFilters() { document.getElementById('archiveFilterEmp').value=""; document.getElementById('archiveFilterFrom').value=""; document.getElementById('archiveFilterTo').value=""; renderArchive(); }
    function resetReportFilters() { document.getElementById('reportFilterEmp').value=""; document.getElementById('reportFilterFrom').value=""; document.getElementById('reportFilterTo').value=""; renderReports(); }

</script>
</body>
</html>
